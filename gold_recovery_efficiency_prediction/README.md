# Исследование технологического процесса очистки золота

Построена модель для определения доли золота на выходе производственного процесса в завивисомсти от множества его входных параметров. Исследованы концентрации веществ на разных этапах техпроцесса, проведено тщательно сравнение обучающей и тестовой выборки.

## Ссылка на полноценный просмотр ноутбука

https://nbviewer.org/github/anton-kaptoh/Practicum/blob/main/gold_recovery_efficiency_prediction/GoldRecoveryCoefficientPrediction.ipynb

## Tags
regression, pipeline, scikit-learn, Gradient Boosting, matplotlib, seaborn, industry

## Шаги/ход исследования
- [1. Восстановление золота из руды](#1.-Восстановление-золота-из-руды)
  - [1.1. Подготовка данных](#1.1.-Подготовка-данных)
    - [1.1.1. Импорты](#1.1.1.-Импорты)
    - [1.1.2. Загрузка данных](#1.1.2.-Загрузка-данных)
    - [1.1.3. Структура данных](#1.1.3.-Структура-данных)
    - [1.1.4. Признаки и индексы в тестовой выборке](#1.1.4.-Признаки-и-индексы-в-тестовой-выборке)
    - [1.1.5. Диаграммы размаха](#1.1.5.-Диаграммы-размаха)
    - [1.1.6. EDA  с помощью pandas profiling](#1.1.6.-EDA--с-помощью-pandas-profiling)
    - [1.1.7. Признак date](#1.1.7.-Признак-date)
    - [1.1.8. Пропуски в данных](#1.1.8.-Пропуски-в-данных)
    - [1.1.9. EDA  с помощью sweetviz](#1.1.9.-EDA--с-помощью-sweetviz)
    - [1.1.10. Корреляционные матрицы](#1.1.10.-Корреляционные-матрицы)
    - [1.1.11. Эффективность обогащения](#1.1.11.-Эффективность-обогащения)
  - [1.2. Анализ данных](#1.2.-Анализ-данных)
    - [1.2.1. Концентрация металлов на разных этапах очистки](#1.2.1.-Концентрация-металлов-на-разных-этапах-очистки)
    - [1.2.2. Распределение гранул сырья](#1.2.2.-Распределение-гранул-сырья)
    - [1.2.3. Концентрация веществ на разных стадиях](#1.2.3.-Концентрация-веществ-на-разных-стадиях)
  - [1.3. Модель](#1.3.-Модель)
    - [1.3.1. Метрика качества sMAPE](#1.3.1.-Метрика-качества-sMAPE)
    - [1.3.2. Pipeline](#1.3.2.-Pipeline)
      - [1.3.2.1. Кастомные классы и функции](#1.3.2.1.-Кастомные-классы-и-функции)
      - [1.3.2.2. Сборка пайплайна](#1.3.2.2.-Сборка-пайплайна)
      - [1.3.2.3. Перебираемые гиперпараметры](#1.3.2.3.-Перебираемые-гиперпараметры)
    - [1.3.3. Прогнозирование эффективности обогащения (флотации)](#1.3.3.-Прогнозирование-эффективности-обогащения-(флотации))
      - [1.3.3.1. Feature importances](#1.3.3.1.-Feature-importances)
    - [1.3.4. Прогнозирование финальной эффективности обогащения с очисткой](#1.3.4.-Прогнозирование-финальной-эффективности-обогащения-с-очисткой)
    - [1.3.5. Итоговое sMAPE](#1.3.5.-Итоговое-sMAPE)
    - [1.3.6. Проверка модели на адекватность](#1.3.6.-Проверка-модели-на-адекватность)
      - [1.3.6.1. Эффективность DummyRegressor для rougher](#1.3.6.1.-Эффективность-DummyRegressor-для-rougher)
      - [1.3.6.2. Эффективность DummyRegressor для финальной стадии](#1.3.6.2.-Эффективность-DummyRegressor-для-финальной-стадии)
      - [1.3.6.3. Итоговое sMAPE для DummyRegressor](#1.3.6.3.-Итоговое-sMAPE-для-DummyRegressor)
  - [1.4. Общий вывод](#1.4.-Общий-вывод)

## Выводы
Выполняя предварительный анализ датасетов, мы обратили внимание на следующее:
* <b>не слишком удачный выбор индексов для тестовых данных</b> (недостаточно случайное распределение), что привело к видимой разнице в распределениях признаков:
  * В сравнительном отчете <b>для тестовой/обучающей выборок мы увидели много различий в распределениях признаков</b>. Например, в наиболее влияющем на значения recovery - сульфате на входе в первый очиститель (primary_cleaner.input.sulfate - pi.sulfate) увидели сильное смещение пиков test-гистограммы относительно train-гистограммы. Или, например, во влияющих на значения recovery для этапа флотации - концентрациях веществ на входе rougher.input.feed_ag, rougher.input.feed_pb, rougher.input.feed_au также видны смещения пиков test-гистограммы относительно train-гистограммы и, соответственно, отличия в целевых признаках.
  * Обнаружили также, что распределение гранул сырья в тестовой выборке имеет отличия от распределения обучающего датасета. Возможно эти различия не настолько серьезные
* На диаграммах размаха для признаков доступных в тестовой выборке мы видим, что <b>почти у всех признаков есть выбросы</b> - что может повлиять на качество работы нашей модели. Следует попробовать обработать выбросы с помощью специальных scaler-ов (PowerTransformer, например).
* Обнаружили строки с <b>пропусками и нулевыми суммами долей веществ</b> и далее обработали их моделью с помощью Imputer-ов. 
* Касательно <b>концентраций</b> различных веществ мы обратили внимание на следующее:
  * Доля золота, ожидаемо, постоянно растет по мере движения по этапам техпроцесса. 
  * Доля свинца в концентрате также растет, но рост этот затухающий. 
  * Процентное содержание серебра в концентрате вырастает после этапа флотации, но потом на этапах очистки снижается до величины почти в 2 раза меньшей чем до начала обработки руды.  
  * Доля же всех металлов в отвальных хвостах имеет схожую динамику - она растет до этапов очистки а после них начинает снижаться.
Были построены две похожие <b>модели для расчета recovery флотационного этапа и recovery всего техпроцесса с очисткой</b>:
* с помощью кастомного класса было реализовано извлечение дня года/месяца/недели, часа из признака date и добавление их в датафрейм для последующего использования в модели
* с помощью RandomizedSearchCV было реализовано следующее:
  * кросс-валидация на 10 фолдах
  * подбор imputer-ов
  * подбор scaler-ов
* с помощью кастомного класса и параметров для RandomizedSearchCV был реализован перебор трех моделей (RandomForestRegressor, AdaBoostRegressor, GradientBoostingRegressor) и параметров к ним
* получили итоговое <b>sMAPE для тестовой выборки</b> ~ 8.35%